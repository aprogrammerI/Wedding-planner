<!-- Header Controls -->
<div class="d-flex justify-content-end gap-2 mb-3">
  <button class="btn btn-primary" (click)="sortByPriority()">Sort By Priority</button>
  <button class="btn btn-outline-secondary" *ngIf="isSortedByPriority" (click)="resetSort()">Reset Sort</button>
  <button class="btn btn-primary" (click)="toggleAddForm()">
    {{ showAddForm ? 'Close' : 'Add Task' }}
  </button>
</div>

<!-- Debug Info (remove in production) -->
<div class="alert alert-info" *ngIf="false">
  <small>
    Tasks: {{ tasks.length }} | 
    Overdue: {{ overdueReminders.length }} | 
    Upcoming: {{ upcomingReminders.length }} | 
    Sorted: {{ isSortedByPriority }} | 
    Filtered: {{ showFilteredTasks }}
  </small>
</div>

<!-- Task Filters -->
<div class="task-filters mb-3" *ngIf="!isSortedByPriority && !showFilteredTasks">
  <div class="row g-2 align-items-center">
    <div class="col-md-3">
      <label class="form-label">Filter by assigned person:</label>
    </div>
    <div class="col-md-4">
      <select class="form-select" (change)="filterByAssignee($any($event.target).value)">
        <option value="">All tasks</option>
        <option *ngFor="let user of availableUsers" [value]="user">{{ user }}</option>
      </select>
    </div>
  </div>
</div>

<!-- Add Task Form -->
<div *ngIf="showAddForm" class="mb-3 row g-2 align-items-end">
  <div class="col-md-4">
    <label class="form-label">Title <span class="text-danger">*</span></label>
    <input [(ngModel)]="newTitle" class="form-control" placeholder="Task title" required />
    <div class="invalid-feedback" *ngIf="!newTitle.trim() && showAddForm">
      Task title is required
    </div>
  </div>
  <div class="col-md-2">
    <label class="form-label">Due date</label>
    <input type="date" [(ngModel)]="newDueDate" (change)="onDueDateChange()" class="form-control" />
  </div>
  <div class="col-md-2">
    <label class="form-label">Priority</label>
    <select [(ngModel)]="newPriority" class="form-select">
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Assign to</label>
    <select [(ngModel)]="newAssignedTo" class="form-select">
      <option value="">Select person</option>
      <option *ngFor="let user of availableUsers" [value]="user">{{ user }}</option>
    </select>
  </div>
  <div class="col-md-2 d-flex gap-2">
    <button (click)="add()" class="btn btn-primary w-100" [disabled]="!newTitle.trim()">Add</button>
    <button (click)="cancelAdd()" class="btn btn-outline-secondary w-100">Cancel</button>
  </div>
  <div class="col-12">
    <label class="form-label">Description</label>
    <textarea [(ngModel)]="newDescription" class="form-control" rows="2" placeholder="Optional description"></textarea>
  </div>
  <div class="col-md-4">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" [(ngModel)]="newReminderEnabled" (change)="onReminderEnabledChange()" id="reminderCheck">
      <label class="form-check-label" for="reminderCheck">
        Enable reminder
      </label>
    </div>
  </div>
  <div class="col-md-4" *ngIf="newReminderEnabled">
    <label class="form-label">Reminder date</label>
    <input type="date" [(ngModel)]="newReminderDate" class="form-control" />
    <small class="text-muted">Defaults to due date if not set</small>
  </div>
</div>

<!-- Reusable Task Template -->
<ng-template #taskTemplate let-task>
  <li class="list-group-item" [class.expanded]="expandedTaskId === task.id">
    <div class="d-flex justify-content-between align-items-start gap-3" (click)="toggleExpandTask(task)" style="cursor:pointer;">
      <div class="form-check mt-1" (click)="$event.stopPropagation()">
        <input class="form-check-input"
               type="checkbox"
               [checked]="task.done"
               [id]="'task-checkbox-' + task.id"
               (change)="onDoneChange(task, $any($event.target).checked)"
               [attr.aria-label]="'Mark task ' + task.title + ' as ' + (task.done ? 'incomplete' : 'complete')" />
        <label class="form-check-label" [for]="'task-checkbox-' + task.id" class="visually-hidden">
          Mark task as {{ task.done ? 'incomplete' : 'complete' }}
        </label>
      </div>
      <div class="flex-grow-1">
        <div *ngIf="editingTaskId !== task.id; else editForm">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <span class="fw-semibold" [class.text-decoration-line-through]="task.done">
                {{ task.title }}
              </span>
              <span class="badge ms-2" [ngClass]="{
                'priority-low': task.priority==='low',
                'priority-medium': task.priority==='medium',
                'priority-high': task.priority==='high'
              }">{{ task.priority || 'medium' }}</span>
              <span *ngIf="getSubtaskCount(task) > 0" class="ms-2 text-muted small">({{ getCompletedSubtaskCount(task) }}/{{ getSubtaskCount(task) }})</span>
            </div>
          </div>
          <div class="text-muted small" *ngIf="task.description">{{ task.description }}</div>
          <div class="text-muted small" *ngIf="task.assignedTo">
            <i class="fas fa-user me-1"></i>Assigned to: {{ task.assignedTo }}
          </div>
          <div class="text-muted small" *ngIf="task.reminderEnabled && task.reminderDate">
            <i class="fas fa-bell me-1" [ngClass]="{
              'text-warning': isReminderDueSoon(task),
              'text-danger': isReminderOverdue(task)
            }"></i>{{ getReminderStatus(task) }}
          </div>
          <div class="text-muted small" *ngIf="task.vendorId">
            <i class="fas fa-briefcase me-1"></i>
            Vendor: {{ getVendorById(task.vendorId)?.name }} <span class="text-muted">({{ getVendorById(task.vendorId)?.category }})</span>
          </div>
        </div>
        <ng-template #editForm>
          <div class="row g-2">
            <div class="col-md-5">
              <input [(ngModel)]="editDraft.title"
                     class="form-control form-control-sm"
                     placeholder="Title" />
            </div>
            <div class="col-md-2">
              <select [(ngModel)]="editDraft.priority" class="form-select form-select-sm">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="col-md-3">
              <select [(ngModel)]="editDraft.assignedTo" class="form-select form-select-sm">
                <option value="">Select person</option>
                <option *ngFor="let user of availableUsers" [value]="user">{{ user }}</option>
              </select>
            </div>
            <div class="col-md-2 d-flex gap-2">
              <button (click)="saveEdit()" class="btn btn-sm btn-primary">Save</button>
              <button (click)="cancelEdit()" class="btn btn-sm btn-outline-secondary">Cancel</button>
            </div>
            <div class="col-12">
              <textarea [(ngModel)]="editDraft.description"
                        class="form-control form-control-sm"
                        rows="2"
                        placeholder="Description"></textarea>
            </div>
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       [(ngModel)]="editDraft.reminderEnabled"
                       [id]="'editReminderCheck' + task.id">
                <label class="form-check-label" [for]="'editReminderCheck' + task.id">
                  Enable reminder
                </label>
              </div>
            </div>
            <div class="col-md-4" *ngIf="editDraft.reminderEnabled">
              <label class="form-label form-label-sm">Due/Reminder Date</label>
              <input type="date"
                     [(ngModel)]="editDraft.reminderDate"
                     class="form-control form-control-sm"
                     placeholder="Due/Reminder date" />
            </div>
          </div>
        </ng-template>
      </div>
      <div class="task-actions" (click)="$event.stopPropagation()">
        <mat-icon class="edit-icon"
                  (click)="startEdit(task)"
                  title="Edit Task">edit</mat-icon>
        <mat-icon class="delete-icon"
                  (click)="remove(task.id)"
                  title="Delete Task">delete</mat-icon>
        <mat-icon class="add-subtask-icon"
                  (click)="addSubtask(task)"
                  title="Add Subtask">add</mat-icon>
      </div>
    </div>
    <!-- Subtasks List -->
    <ul *ngIf="task.subtasks && task.subtasks.length && expandedTaskId === task.id" class="subtask-list ms-4 mt-2">
      <li *ngFor="let sub of task.subtasks" class="align-items-center d-flex gap-2">
        <input type="checkbox" 
               [(ngModel)]="sub.done" 
               (change)="updateSubtaskStatus(task, sub)"
               [id]="'subtask-checkbox-' + sub.id"
               [attr.aria-label]="'Mark subtask ' + sub.title + ' as ' + (sub.done ? 'incomplete' : 'complete')">
        <label [for]="'subtask-checkbox-' + sub.id" class="form-label mb-0">{{ sub.title }}</label>
        <span class="subtask-actions">
          <mat-icon class="subtask-edit-icon" (click)="editSubtask(task, sub)" title="Edit Subtask">edit</mat-icon>
          <mat-icon class="subtask-delete-icon" (click)="deleteSubtask(task, sub)" title="Delete Subtask">delete</mat-icon>
        </span>
      </li>
    </ul>
  </li>
</ng-template>

<!-- Filtered Tasks View -->
<div *ngIf="showFilteredTasks" class="mb-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">
      <i class="fas fa-user me-2"></i>Tasks assigned to: {{ selectedAssignee }}
    </h5>
    <button class="btn btn-outline-secondary btn-sm" (click)="clearAssigneeFilter()">
      <i class="fas fa-times me-1"></i>Clear Filter
    </button>
  </div>

  <ul class="list-group">
    <ng-container *ngFor="let t of getTasksByAssignee(selectedAssignee)">
      <ng-container *ngTemplateOutlet="taskTemplate; context: { $implicit: t }">
      </ng-container>
    </ng-container>
  </ul>
</div>

<!-- Regular Tasks Display -->
<div *ngIf="!isSortedByPriority && !showFilteredTasks">
  <ul class="list-group">
    <ng-container *ngFor="let t of tasks">
      <ng-container *ngTemplateOutlet="taskTemplate; context: { $implicit: t }">
      </ng-container>
    </ng-container>
  </ul>
</div>

<!-- Priority Sorted View -->
<div *ngIf="isSortedByPriority">
  <!-- High Priority Section -->
  <div class="mb-4" *ngIf="getTasksByPriority('high').length > 0">
    <h6 class="mb-3 text-muted">
      <i class="fas fa-exclamation-triangle me-2"></i>High Priority
    </h6>
          <ul class="list-group">
        <ng-container *ngFor="let t of getTasksByPriority('high')">
          <ng-container *ngTemplateOutlet="taskTemplate; context: { $implicit: t }">
          </ng-container>
        </ng-container>
      </ul>
  </div>

  <!-- Medium Priority Section -->
  <div class="mb-4" *ngIf="getTasksByPriority('medium').length > 0">
    <h6 class="mb-3 text-muted">
      <i class="fas fa-minus-circle me-2"></i>Medium Priority
    </h6>
          <ul class="list-group">
        <ng-container *ngFor="let t of getTasksByPriority('medium')">
          <ng-container *ngTemplateOutlet="taskTemplate; context: { $implicit: t }">
          </ng-container>
        </ng-container>
      </ul>
  </div>

  <!-- Low Priority Section -->
  <div class="mb-4" *ngIf="getTasksByPriority('low').length > 0">
    <h6 class="mb-3 text-muted">
      <i class="fas fa-arrow-down me-2"></i>Low Priority
    </h6>
          <ul class="list-group">
        <ng-container *ngFor="let t of getTasksByPriority('low')">
          <ng-container *ngTemplateOutlet="taskTemplate; context: { $implicit: t }">
          </ng-container>
        </ng-container>
      </ul>
  </div>
</div>

<!-- Task Summary -->
<div class="task-summary-simple mt-4" *ngIf="!isSortedByPriority && !showFilteredTasks">
  <div class="card">
    <div class="card-body text-center">
      <h6 class="mb-3">
        <i class="fas fa-chart-pie me-2"></i>Overall Progress
      </h6>
      <div class="progress mb-2" style="height: 20px;">
        <div class="progress-bar"
             [style.width.%]="getOverallTaskCompletionPercentage()"
             [ngClass]="{
               'bg-success': getOverallTaskCompletionPercentage() >= 80,
               'bg-warning': getOverallTaskCompletionPercentage() >= 50 && getOverallTaskCompletionPercentage() < 80,
               'bg-danger': getOverallTaskCompletionPercentage() < 50
             }">
          {{ getOverallTaskCompletionPercentage() }}%
        </div>
      </div>
      <small class="text-muted">
        {{ getCompletedTasks().length }} completed out of {{ tasks.length }} total tasks
      </small>
    </div>
  </div>
</div>

<!-- Reminder Notifications -->
<div class="reminder-notifications mt-4" *ngIf="overdueReminders.length > 0 || upcomingReminders.length > 0">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="mb-0">
      <i class="fas fa-bell me-2"></i>Reminder Notifications
    </h6>
    <!-- Refresh button removed -->
  </div>

  <!-- Overdue Reminders -->
  <div class="alert alert-danger" *ngIf="overdueReminders.length > 0">
    <h6 class="alert-heading">
      <i class="fas fa-exclamation-triangle me-2"></i>Overdue Reminders ({{ overdueReminders.length }})
    </h6>
    <div class="reminder-list">
<!--      <div *ngFor="let task of overdueReminders" class="reminder-item">-->
<!--        <strong>{{ task.title }}</strong> - {{ getReminderStatus(task) }}-->
<!--        <span *ngIf="task.assignedTo" class="ms-2 text-muted">({{ task.assignedTo }})</span>-->
<!--      </div>-->

      <li *ngFor="let r of overdueReminders">
        <strong>{{ r.title }}</strong>
        <span class="ms-2 text-muted" *ngIf="r.assignee">({{ assigneeLabel(r.assignee) }})</span>
        <span class="ms-2">- Overdue by {{ r.daysOverdue }} day(s)</span>
      </li>

    </div>
  </div>

  <!-- Upcoming Reminders -->
  <div class="alert alert-warning" *ngIf="upcomingReminders.length > 0">
    <h6 class="alert-heading">
      <i class="fas fa-bell me-2"></i>Upcoming Reminders ({{ upcomingReminders.length }})
    </h6>
    <div class="reminder-list">
      <div *ngFor="let task of upcomingReminders" class="reminder-item">
        <strong>{{ task.title }}</strong> - {{ getReminderStatus(task) }}
        <span *ngIf="task.assignedTo" class="ms-2 text-muted">({{ task.assignedTo }})</span>
      </div>
    </div>
  </div>
</div>
