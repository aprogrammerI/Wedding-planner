<div class="d-flex justify-content-end gap-2 mb-3">
  <button class="btn btn-primary" (click)="sortByPriority()">Sort By Priority</button>
  <button class="btn btn-primary" (click)="toggleAddForm()">
    {{ showAddForm ? 'Close' : 'Add Task' }}
  </button>
</div>

<div *ngIf="showAddForm" class="mb-3 row g-2 align-items-end">
  <div class="col-md-5">
    <label class="form-label">Title</label>
    <input [(ngModel)]="newTitle" class="form-control" placeholder="Task title" />
  </div>
  <div class="col-md-3">
    <label class="form-label">Due date</label>
    <input type="date" [(ngModel)]="newDueDate" class="form-control" />
  </div>
  <div class="col-md-2">
    <label class="form-label">Priority</label>
    <select [(ngModel)]="newPriority" class="form-select">
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>
  </div>
  <div class="col-md-2 d-flex gap-2">
    <button (click)="add()" class="btn btn-primary w-100">Add</button>
    <button (click)="cancelAdd()" class="btn btn-outline-secondary w-100">Cancel</button>
  </div>
  <div class="col-12">
    <label class="form-label">Description</label>
    <textarea [(ngModel)]="newDescription" class="form-control" rows="2" placeholder="Optional description"></textarea>
  </div>
</div>

<ul class="list-group">
  <li *ngFor="let t of tasks" class="list-group-item">
    <div class="d-flex justify-content-between align-items-start gap-3">
      <div class="form-check mt-1">
        <input class="form-check-input" type="checkbox" [checked]="t.done" (change)="onDoneChange(t, $any($event.target).checked)" />
      </div>

      <div class="flex-grow-1">
        <div *ngIf="editingTaskId !== t.id; else editForm">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <span class="fw-semibold" [class.text-decoration-line-through]="t.done">{{ t.title }}</span>
              <span class="badge ms-2" [ngClass]="{
                'priority-low': t.priority==='low',
                'priority-medium': t.priority==='medium',
                'priority-high': t.priority==='high'
              }">{{ t.priority || 'medium' }}</span>
            </div>
            <small class="text-muted" *ngIf="t.dueDate">Due: {{ t.dueDate }}</small>
          </div>
          <div class="text-muted small" *ngIf="t.description">{{ t.description }}</div>
        </div>

        <ng-template #editForm>
          <div class="row g-2">
            <div class="col-md-5">
              <input [(ngModel)]="editDraft.title" class="form-control form-control-sm" placeholder="Title" />
            </div>
            <div class="col-md-3">
              <input type="date" [(ngModel)]="editDraft.dueDate" class="form-control form-control-sm" />
            </div>
            <div class="col-md-2">
              <select [(ngModel)]="editDraft.priority" class="form-select form-select-sm">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="col-md-2 d-flex gap-2">
              <button (click)="saveEdit()" class="btn btn-sm btn-primary">Save</button>
              <button (click)="cancelEdit()" class="btn btn-sm btn-outline-secondary">Cancel</button>
            </div>
            <div class="col-12">
              <textarea [(ngModel)]="editDraft.description" class="form-control form-control-sm" rows="2" placeholder="Description"></textarea>
            </div>
          </div>
        </ng-template>
      </div>

      <div class="d-flex flex-column gap-2">
        <button (click)="startEdit(t)" class="btn btn-sm btn-outline-primary">Edit</button>
        <button (click)="remove(t.id)" class="btn btn-sm btn-outline-danger">Delete</button>
      </div>
    </div>
  </li>
</ul>
